const RTVT_SDK_VERSION="1.0.1",RTVT_ERROR_CODE={RTVT_EC_TOKEN_INVALID:300001,RTVT_EC_VOICE_LENGTH_ERROR:300002,RTVT_EC_STREAM_ERROR:300003};function isException(e,t){if(!t)return new fpnn.FPError(fpnn.FPConfig.ERROR_CODE.FPNN_EC_PROTO_UNKNOWN_ERROR,Error("data is null"));if(t instanceof Error){let i=fpnn.FPConfig.ERROR_CODE.FPNN_EC_PROTO_UNKNOWN_ERROR;return void 0!==t.code&&(i=t.code),new fpnn.FPError(i,t)}return e&&t.hasOwnProperty("code")&&t.hasOwnProperty("ex")?new fpnn.FPError(t.code,Error(t.ex)):null}function sendQuest(e,t,i,n){let s=this;if(!e){i&&i(new fpnn.FPError(fpnn.FPConfig.ERROR_CODE.FPNN_EC_CORE_INVALID_CONNECTION,Error("invalid connection")),null);return}e.sendQuest(t,function(e){if(!i)return;let t=null,n=!1;if(e.payload){let r=msgpack.decode(e.payload,{codec:msgpack.createCodec({int64:!0})});if(2==e.mtype&&(n=0!=e.ss),t=isException.call(s,n,r)){i&&i(t,null);return}i&&i(null,r);return}if(t=isException.call(s,n,e)){i&&i(t,null);return}i&&i(null,e)},n)}class RTVTStream{constructor(e){fpnn.FPEvent.assign(this),this._id=e.id,this._srcLang=e.srcLang,this._destLang=e.destLang,this._asrResult=e.asrResult,this._streamID=e.streamID,this._client=e.client}getStreamID(){return this._streamID}close(e){var t={streamId:this._streamID};void 0!==e&&(t[e]=e);let i={flag:1,method:"voiceEnd",payload:msgpack.encode(t)},n=this;sendQuest.call(this,this._client._client,i,function(e,t){e||n._client._removeStream(n._id)},this._timeout)}}class RTVTClient{constructor(e){fpnn.FPEvent.assign(this),this._endpoint=e.endpoint,this._pid=e.pid,this._uid=e.uid,this._timeout=e.timeout||5e3,this._canReconnect=!1,this._reconnectInterval=5e3,this._streamIDSeq=1,this._reconnectTimer=0,this._lastReconnectTime=0,this._streamMap={},this._streamID2IDMap={},this._lastPingTime=-1,this._pingTimers=0,this._pingSeconds=5,this._clientVersion=0,this._sendBuffer=[],this._sendBufferMaxLimit=e.bufferLimit||1e3,this._sendingStatus=!1}login(e,t,i){this._login(e,t,i)}destory(){this._canReconnect=!1,this.stopAllStreams(),this._client.close()}stopAllStreams(){for(var e in this._streamMap)this._streamMap[e].close(),delete this._streamMap[e]}createStream(e,t,i,n,s){let r={flag:1,method:"voiceStart",payload:msgpack.encode({asrResult:i,srcLanguage:e,destLanguage:t})},o=this;sendQuest.call(o,o._client,r,function(r,a){if(r)n&&n(null,r.code);else{var c={srcLang:e,destLang:t,asrResult:i,streamID:a.streamId,client:o};void 0===s?c.id=o._streamIDSeq++:c.id=s;var l=new RTVTStream(c);void 0===s&&(o._streamMap[l._id]=l,o._streamID2IDMap[l._streamID.toString()]=l._id),n(l,0)}},this._timeout)}sendVoice(e,t,i){if(640!=i.byteLength)return RTVT_ERROR_CODE.RTVT_EC_VOICE_LENGTH_ERROR;if(void 0===this._streamMap[e._id])return RTVT_ERROR_CODE.RTVT_EC_STREAM_ERROR;var n={streamId:this._streamMap[e._id]._streamID,seq:t,data:i,ts:new Int64BE(parseInt(""+new Date().getTime()))};let s={flag:1,method:"voiceData",payload:msgpack.encode(n,{codec:msgpack.createCodec({binarraybuffer:!0})}),ts:new Int64BE(parseInt(""+new Date().getTime()))},r=this;sendQuest.call(this,this._client,s,function(e,t){e&&(r.emit("ErrorRecorder",e),800001==e.code&&r.onClose())},r._timeout)}_removeStream(e){delete this._streamMap[e]}_login(e,t,i){this._token=e,this._ts=t,this._client=new fpnn.FPClient({endpoint:this._endpoint+"/service/websocket",autoReconnect:!1,connectionTimeout:1e4}),this._client.clientVersion=this._clientVersion++;let n=this;this._client.events={},this._client.on("connect",function(){let e={flag:1,method:"login",payload:msgpack.encode({pid:n._pid,token:n._token,ts:n._ts,uid:n._uid,version:"1.0.1"})};sendQuest.call(n,n._client,e,function(e,t){e?(n._canReconnect=!1,i&&i(!1,e.code)):(n._canReconnect=!0,i&&i(!0,fpnn.FPConfig.ERROR_CODE.FPNN_EC_OK)),n._client.events={},n._client.on("close",function(){n.clientVersion==n._client.clientVersion&&n.onClose()}),n._client.on("error",function(e){n.emit("ErrorRecorder",e)}),n._client.processor.on("recognizedResult",function(e,t){let i=msgpack.decode(e,{codec:msgpack.createCodec({int64:!0})});n.emit("recognizedResult",i)}),n._client.processor.on("translatedResult",function(e,t){let i=msgpack.decode(e,{codec:msgpack.createCodec({int64:!0})});n.emit("translatedResult",i)}),0!=n._pingTimers&&clearTimeout(n._pingTimers),n._pingTimers=setTimeout(function(){n._updatePingTime()},1e3*n._pingSeconds)},this._timeout)}),this._client.connect()}_updatePingTime(){let e={flag:1,method:"*ping",payload:msgpack.encode({})},t=this;sendQuest.call(this,this._client,e,function(e,i){let n=parseInt(new Date().getTime())/1e3;e||(t._lastPingTime=n),-1!=t._lastPingTime&&n-t._lastPingTime>=5?t.onClose():(0!=t._pingTimers&&clearTimeout(t._pingTimers),t._pingTimers=setTimeout(function(){t._updatePingTime()},1e3*t._pingSeconds))},2e3)}onClose(){if(!this._canReconnect){this.emit("SessionClosed",fpnn.FPConfig.ERROR_CODE.FPNN_EC_CORE_CONNECTION_CLOSED);return}var e=0;let t=parseInt(new Date().getTime());this._lastReconnectTime>0&&t-this._lastReconnectTime<1e3&&(e=this._reconnectInterval-t+this._lastReconnectTime);let i=this;this._reconnectTimer=setTimeout(function(){i._lastReconnectTime=parseInt(new Date().getTime()),i._login(i._token,i._ts,function(e,t){if(e){let n=Object.keys(i._streamMap).length;if(n>0){var s={},r=0;for(var o in i._streamMap){let a=i._streamMap[o];i.createStream(a._srcLang,a._destLang,a._asrResult,function(e,t){if(null==e){i.emit("ErrorRecorder","recover stream error: "+t);return}if(s[e._id]=e,++r>=n){var o={};for(var a in s)o[s[a]._streamID.toString()]=1,i._streamMap[a]=s[a],i._streamID2IDMap[s[a]._streamID.toString()]=s[a]._id,i.emit("ErrorRecorder","recover stream, streamID: "+s[a]._streamID.toString()+", ID: "+a);for(var a in i._streamMap)void 0===s[a]&&(delete i._streamID2IDMap[i._streamMap[a]._streamID.toString()],delete i._streamMap[a]);for(var c in i._streamID2IDMap)void 0==o[c]&&delete i._streamID2IDMap[c]}},a._id)}}i._canReconnect=!0,i.emit("ReloginCompleted",!0,0);return}if(800101==t||800103==t){i._canReconnect=!1,i.emit("SessionClosed",RTVT_ERROR_CODE.RTVT_EC_TOKEN_INVALID);return}i.emit("ReloginCompleted",!1,t),i.onClose()})},e)}}